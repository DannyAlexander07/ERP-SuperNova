<div class="terceros-container fade-in">
    
    <div class="module-header">
        <div class="header-titles">
            <h2>ü§ù Canales Externos y Canjes</h2>
            <p>Validaci√≥n de c√≥digos (Joinnus, Cuponatic) y gesti√≥n de acuerdos B2B.</p>
        </div>
        
        <div class="header-actions">
            <div class="tabs-terceros">
                <button class="tab-btn active" onclick="cambiarTabTerceros('validacion')">
                    <i class='bx bx-qr-scan'></i> Validaci√≥n (Caja)
                </button>
                <button class="tab-btn" onclick="cambiarTabTerceros('gestion')">
                    <i class='bx bx-briefcase-alt-2'></i> Gesti√≥n y Acuerdos
                </button>
            </div>
        </div>
    </div>

    <div id="view-validacion" class="tab-content active">
        <div class="validation-wrapper">
            <div class="scanner-card">
                <h3>üîç Escanear o Digitar C√≥digo</h3>
                <p>Ingresa el c√≥digo del cup√≥n o entrada externa para validar el acceso.</p>
                
                <div class="input-group-lg">
                    <input type="text" id="input-codigo-canje" placeholder="Ej: CUP-8842-X" autocomplete="off">
                    <button class="btn-primary btn-lg" onclick="validarCodigo()">
                        <i class='bx bx-check-circle'></i> VALIDAR
                    </button>
                </div>
                <small>Presiona ENTER despu√©s de escanear.</small>

                <div id="resultado-validacion" class="result-box hidden">
                    </div>
            </div>

            <div class="history-card">
                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
                    <h4 style="margin:0;">‚è±Ô∏è √öltimos Canjes Hoy</h4>
                    <button class="btn-xs" onclick="abrirModalHistorialTotal()" title="Ver Todos los Tiempos">
                        <i class='bx bx-history'></i> Ver Todo
                    </button>
                </div>
                
                <ul id="lista-ultimos-canjes" style="min-height: 200px;">
                    <li class="empty-msg">Cargando...</li>
                </ul>

                <div class="mini-pagination">
                    <button id="btn-mini-prev" onclick="cambiarPaginaMini(-1)" disabled class="btn-xs">‚óÄ</button>
                    <span id="txt-mini-page">Pg 1</span>
                    <button id="btn-mini-next" onclick="cambiarPaginaMini(1)" disabled class="btn-xs">‚ñ∂</button>
                </div>
            </div> 
        </div>
    </div>

    <div id="view-gestion" class="tab-content">
        <div class="gestion-grid">
            
            <div class="panel-acuerdos">
                <div class="panel-head">
                    <h3>üìú Acuerdos Comerciales</h3>
                    <button class="btn-sm btn-secondary" onclick="abrirModalNuevoAcuerdo()">
                        <i class='bx bx-plus'></i> Nuevo Acuerdo
                    </button>
                </div>
                
                <div class="table-responsive">
                    <table class="simple-table" id="tabla-acuerdos">
                        <thead>
                            <tr>
                                <th>#</th>
                                <th>Empresa</th>
                                <th>Descripci√≥n</th>
                                <th>Entradas</th>
                                <th>Total</th>
                                <th>Acciones</th>
                            </tr>
                        </thead>
                        <tbody id="tabla-acuerdos-body">
                            </tbody>
                    </table>
                </div>

                <div class="pagination-controls">
                    <button id="btn-prev" onclick="cambiarPagina(-1)" disabled>
                        <i class='bx bx-chevron-left'></i> Anterior
                    </button>
                    <span id="page-info">P√°gina 1</span>
                    <button id="btn-next" onclick="cambiarPagina(1)">
                        Siguiente <i class='bx bx-chevron-right'></i>
                    </button>
                </div>
            </div>
            
            <div class="panel-carga" class="tab-content">
                <h3>üì• Gesti√≥n de C√≥digos</h3>
                
                <div class="tabs-mini-bar">
                    <button class="btn-xs active" id="tab-carga-manual" onclick="toggleModoCarga('manual')">Pegar Manual</button>
                    <button class="btn-xs" id="tab-carga-auto" onclick="toggleModoCarga('auto')">‚ú® Generar Autom√°tico</button>
                </div>

                <div class="form-group">
                    <label>Seleccionar Acuerdo:</label>
                    <select id="select-acuerdo-carga" class="form-control">
                        <option value="">-- Seleccione --</option>
                    </select>
                </div>

                <div id="bloque-carga-manual">
                    <div class="form-group">
                        <label>Pegar C√≥digos (Excel/Txt):</label>
                        <textarea id="txt-codigos-masivos" rows="6" placeholder="CUP-001&#10;CUP-002..."></textarea>
                    </div>
                    <button class="btn-success full-width" onclick="procesarCargaMasiva()">
                        <i class='bx bx-upload'></i> Cargar Lista
                    </button>
                </div>

                <div id="bloque-carga-auto" style="display:none;">
                    <div class="row">
                        <div class="col">
                            <label>Cantidad:</label>
                            <input type="number" id="gen-cantidad" class="form-control" placeholder="Ej: 100">
                        </div>
                        <div class="col">
                            <label>Prefijo:</label>
                            <input type="text" id="gen-prefijo" class="form-control" placeholder="Ej: BCP">
                        </div>
                    </div>
                    <p style="font-size:0.8rem; color:#666; margin:10px 0;">
                        Se generar√°n c√≥digos √∫nicos tipo: <strong>BCP-X7Z9-1M2P</strong>
                    </p>
                    <button class="btn-primary full-width" onclick="procesarGeneracionAutomatica()">
                        <i class='bx bx-cog'></i> Generar C√≥digos
                    </button>
                </div>
            </div>
        </div>
    </div>

</div>

<div id="modal-acuerdo" class="modal-overlay">
    <div class="modal-content">
        <div class="modal-header">
            <h3>Nuevo Acuerdo Comercial</h3>
            <button class="btn-close" onclick="cerrarModalAcuerdo()"><i class='bx bx-x'></i></button>
        </div>
        <div class="modal-body">
            <form id="form-acuerdo">
                <div class="form-group">
                    <label>Canal / Socio:</label>
                    <div style="display:flex; gap:5px;" id="div-select-canal">
                        <select id="new-canal" class="form-control" required></select>
                        <button type="button" class="btn-plus-canal" onclick="toggleInputCanal()" title="Crear Nuevo">+</button>
                    </div>
                    <div id="div-input-canal" style="display:none; gap:5px;">
                        <input type="text" id="input-new-canal-nombre" class="form-control" placeholder="Nombre (Ej: Groupon)">
                        <button type="button" class="btn-sm" style="background:#10b981; color:white; border:none;" onclick="guardarCanalInline()">OK</button>
                        <button type="button" class="btn-sm" style="background:#ef4444; color:white; border:none;" onclick="toggleInputCanal()">X</button>
                    </div>
                </div>

                <div class="form-group">
                    <label>Descripci√≥n del Paquete:</label>
                    <input type="text" id="new-desc" class="form-control" placeholder="Ej: Lote Febrero 2026" required>
                </div>

                <div class="row">
                    <div class="col">
                        <label>Cantidad Entradas:</label>
                        <input type="number" id="new-cant" class="form-control" required>
                    </div>
                    <div class="col">
                        <label style="color:#166534; font-weight:bold;">Precio Venta Unit. (S/):</label>
                        <input type="number" id="new-precio" class="form-control" step="0.01" placeholder="Ej: 30.00" required>
                    </div>
                </div>

                <div class="row" style="margin-top: 15px; background: #f0fdf4; padding: 15px; border-radius: 8px; border: 1px solid #bbf7d0;">
                    <div class="col">
                        <label style="font-weight:bold; color:#15803d;">¬øC√≥mo pagar√°n?</label>
                        <select id="new-condicion" class="form-control" onchange="toggleCuotas(this.value)">
                            <option value="1">Pago √önico (1 sola cuota)</option>
                            <option value="custom">Cr√©dito en Cuotas</option>
                        </select>
                    </div>
                    <div class="col" id="div-cuotas" style="display:none;">
                        <label style="font-weight:bold; color:#15803d;">N¬∞ de Cuotas:</label>
                        <input type="number" id="new-num-cuotas" class="form-control" value="2" min="2" max="24">
                        <small style="color:#15803d;">Se crear√°n montos iguales, podr√°s editarlos luego.</small>
                    </div>
                </div>

                <div class="form-group" style="margin-top:15px;">
                    <label>Producto a Descontar (Inventario):</label>
                    <select id="new-producto" class="form-control" required></select>
                    <small style="font-size:10px; color:#64748b;">El costo de este producto se registrar√° como costo operativo.</small>
                </div>
                
                <div class="modal-footer">
                    <button type="submit" class="btn-primary">Guardar Acuerdo</button>
                </div>
            </form>
        </div>
    </div>
</div>

<div id="modal-lista-codigos" class="modal-overlay">
    <div class="modal-content" style="max-width: 500px;">
        <div class="modal-header">
            <h3>üî¢ C√≥digos Cargados</h3>
            <button class="btn-close" onclick="cerrarModalCodigos()"><i class='bx bx-x'></i></button>
        </div>
        <div class="modal-body">
            <div style="margin-bottom:10px;">
                <input type="text" id="filtro-codigo" class="form-control" placeholder="üîç Buscar c√≥digo..." onkeyup="filtrarListaCodigos()">
            </div>
            
            <div class="lista-scrollable">
                <table class="simple-table" style="font-size: 0.85rem;">
                    <thead>
                        <tr>
                            <th>C√≥digo</th>
                            <th>Estado</th>
                        </tr>
                    </thead>
                    <tbody id="tabla-codigos-lista">
                    </tbody>
                </table>
            </div>

            <div class="pagination-controls" style="margin-top: 10px; padding-top: 10px; border-top: 1px solid #f1f5f9; justify-content: space-between;">
                <button id="btn-prev-cod" class="btn-sm" onclick="cambiarPaginaCodigos(-1)" disabled>
                    <i class='bx bx-chevron-left'></i> Ant
                </button>
                <span id="page-info-cod" style="font-size: 0.8rem; font-weight:bold; color:#64748b;">Pg 1</span>
                <button id="btn-next-cod" class="btn-sm" onclick="cambiarPaginaCodigos(1)">
                    Sig <i class='bx bx-chevron-right'></i>
                </button>
            </div>
        </div>
    </div>
</div>

<div id="modal-resultado-carga" class="modal-overlay">
    <div class="modal-content" style="max-width: 450px; text-align: center;">
        <div class="modal-body" style="padding: 20px;">
            <div id="icon-resultado" style="font-size: 4rem; margin-bottom: 10px;"></div>
            <h3 id="titulo-resultado" style="margin-bottom: 10px;">Resultado</h3>
            
            <div style="background: #f8fafc; padding: 15px; border-radius: 8px; margin-bottom: 15px; text-align: left;">
                <p>‚úÖ <strong>Insertados:</strong> <span id="res-insertados">0</span></p>
                <p>‚ö†Ô∏è <strong>Duplicados (Ignorados):</strong> <span id="res-duplicados">0</span></p>
            </div>

            <p style="font-size: 0.8rem; color: #64748b;">La carga ha finalizado. Los c√≥digos duplicados ya exist√≠an en el sistema.</p>
        </div>
        <div class="modal-footer" style="justify-content: center;">
            <button class="btn-primary" onclick="cerrarModalResultado()">Entendido</button>
        </div>
    </div>
</div>

<div id="modal-pagos" class="modal-overlay">
    <div class="modal-content" style="max-width: 700px;">
        <div class="modal-header" style="background: #ecfdf5;">
            <h3 style="color:#047857;">üí∞ Gesti√≥n de Pagos</h3>
            <button class="btn-close" onclick="cerrarModalPagos()"><i class='bx bx-x'></i></button>
        </div>
        <div class="modal-body">
            <h4 id="titulo-acuerdo-pagos" style="margin-top:0;">Acuerdo...</h4>
            
            <div class="table-responsive">
                <table class="simple-table">
                    <thead>
                        <tr>
                            <th>#</th>
                            <th>Vencimiento</th>
                            <th>Monto</th>
                            <th>Estado</th>
                            <th>Acci√≥n</th>
                        </tr>
                    </thead>
                    <tbody id="tabla-cuotas-body">
                    </tbody>
                </table>
            </div>
        </div>
        <div class="modal-footer">
            <button class="btn-secondary" onclick="cerrarModalPagos()">Cerrar</button>
        </div>
    </div>
</div>

<div id="modal-detalle-acuerdo" class="modal-overlay">
    <div class="modal-content">
        <div class="modal-header" style="background: #e0f2fe;">
            <h3 style="color:#0369a1;">üìä Progreso del Acuerdo</h3>
            <button class="btn-close" onclick="cerrarModalDetalle()"><i class='bx bx-x'></i></button>
        </div>
        <div class="modal-body">
            <div style="text-align: center; margin-bottom: 20px;">
                <h2 id="view-titulo" style="margin:0; font-size:1.2rem;">Cargando...</h2>
                <small id="view-canal" style="color:#64748b; font-weight:bold;">...</small>
            </div>

            <div style="display:grid; grid-template-columns: 1fr 1fr 1fr; gap:10px; margin-bottom:20px;">
                <div style="background:#f8fafc; padding:15px; border-radius:8px; text-align:center; border:1px solid #cbd5e1;">
                    <span style="display:block; font-size:2rem; font-weight:bold; color:#334155;" id="stat-total">0</span>
                    <small>Cargados</small>
                </div>
                <div style="background:#dcfce7; padding:15px; border-radius:8px; text-align:center; border:1px solid #86efac;">
                    <span style="display:block; font-size:2rem; font-weight:bold; color:#166534;" id="stat-usados">0</span>
                    <small>Canjeados (Usados)</small>
                </div>
                <div style="background:#fff7ed; padding:15px; border-radius:8px; text-align:center; border:1px solid #fdba74;">
                    <span style="display:block; font-size:2rem; font-weight:bold; color:#c2410c;" id="stat-pend">0</span>
                    <small>Pendientes</small>
                </div>
            </div>

            <div class="form-group">
                <label>Producto Asociado:</label>
                <input type="text" id="view-producto" class="form-control" readonly style="background:#f1f5f9;">
            </div>
        </div>
    </div>
</div>

<div id="modal-editar-cuota" class="modal-overlay">
    <div class="modal-content" style="max-width: 400px;">
        <div class="modal-header">
            <h3>‚úèÔ∏è Editar Cuota</h3>
            <button class="btn-close" onclick="cerrarModalEdicion()"><i class='bx bx-x'></i></button>
        </div>
        <div class="modal-body">
            <input type="hidden" id="edit-cuota-id">
            
            <div class="form-group">
                <label>Nuevo Monto (S/):</label>
                <input type="number" id="edit-monto" class="form-control" step="0.01">
                <small style="color:#d97706; font-size:0.75rem;">
                    <i class='bx bx-info-circle'></i> La diferencia se sumar√° a la siguiente cuota.
                </small>
            </div>

            <div class="form-group">
                <label>Nueva Fecha Vencimiento:</label>
                <input type="date" id="edit-fecha" class="form-control">
            </div>
        </div>
        <div class="modal-footer">
            <button class="btn-secondary" onclick="cerrarModalEdicion()">Cancelar</button>
            <button class="btn-primary" onclick="guardarEdicionCuota()">Guardar Cambios</button>
        </div>
    </div>
</div>

<div id="modal-confirmar-pago" class="modal-overlay">
    <div class="modal-content" style="max-width: 500px;">
        <div class="modal-header">
            <h3>üí∏ Cobrar Cuota</h3>
            <button class="btn-close" onclick="cerrarModalConfirmacion()"><i class='bx bx-x'></i></button>
        </div>
        <div class="modal-body">
            <input type="hidden" id="conf-cuota-id">
            
            <div style="background: #ecfdf5; padding: 15px; border-radius: 8px; margin-bottom: 15px; text-align: center;">
                <label style="color: #047857; font-size: 0.9rem;">Monto a Cobrar</label>
                <div id="conf-monto" style="font-size: 2rem; font-weight: 800; color: #059669;">S/ 0.00</div>
            </div>

            <div class="form-group" style="margin-bottom: 15px;">
                <label style="font-weight:bold;">Tipo de Comprobante:</label>
                <div style="display: flex; gap: 10px; margin-top:5px;">
                    <label style="flex: 1; cursor: pointer; background:#f8fafc; padding:8px; border-radius:6px; border:1px solid #e2e8f0; text-align:center;">
                        <input type="radio" name="tipo_comp_cuota" value="Boleta" checked onchange="toggleCamposFacturaCuota()"> üìÑ Boleta
                    </label>
                    <label style="flex: 1; cursor: pointer; background:#f8fafc; padding:8px; border-radius:6px; border:1px solid #e2e8f0; text-align:center;">
                        <input type="radio" name="tipo_comp_cuota" value="Factura" onchange="toggleCamposFacturaCuota()"> üè¢ Factura
                    </label>
                </div>
            </div>

            <div id="bloque-cliente-cuota" style="background:#f1f5f9; padding:10px; border-radius:8px; margin-bottom:15px;">
                <div id="grupo-dni-cuota">
                    <label style="font-size:0.8rem; font-weight:bold; color:#64748b;">Cliente (DNI):</label>
                    <div style="display: flex; gap: 5px; margin-bottom:5px;">
                        <input type="text" id="cuota-dni" class="form-control" placeholder="DNI" maxlength="8">
                        <button class="btn-sm" onclick="buscarEntidadCuota('dni')"><i class='bx bx-search'></i></button>
                    </div>
                    <input type="text" id="cuota-nombre" class="form-control" placeholder="Nombre del Cliente" readonly>
                </div>

                <div id="grupo-ruc-cuota" style="display: none;">
                    <label style="font-size:0.8rem; font-weight:bold; color:#64748b;">Empresa (RUC):</label>
                    <div style="display: flex; gap: 5px; margin-bottom:5px;">
                        <input type="text" id="cuota-ruc" class="form-control" placeholder="RUC" maxlength="11">
                        <button class="btn-sm" onclick="buscarEntidadCuota('ruc')"><i class='bx bx-search'></i></button>
                    </div>
                    <input type="text" id="cuota-razon" class="form-control" placeholder="Raz√≥n Social" readonly style="margin-bottom:5px;">
                    <input type="text" id="cuota-direccion" class="form-control" placeholder="Direcci√≥n Fiscal">
                </div>
            </div>

            <div class="form-group" style="margin-bottom: 15px;">
                <label style="font-weight:bold;">M√©todo de Pago:</label>
                <select id="cuota-metodo" class="form-control" onchange="toggleTarjetaCuota()">
                    <option value="Transferencia" selected>Transferencia</option>
                    <option value="Efectivo">Efectivo</option>
                    <option value="Yape">Yape</option>
                    <option value="Plin">Plin</option>
                    <option value="Tarjeta">Tarjeta (Cr√©dito/D√©bito)</option>
                </select>

                <div id="sub-opcion-tarjeta" style="display:none; margin-top:10px; background:#fff7ed; padding:10px; border:1px solid #fdba74; border-radius:6px;">
                    <label style="font-size:0.8rem; color:#9a3412;">Tipo de Tarjeta:</label>
                    <div style="display: flex; gap: 15px; margin-top:5px;">
                        <label><input type="radio" name="tipo_tarjeta_cuota" value="Debito" checked> D√©bito</label>
                        <label><input type="radio" name="tipo_tarjeta_cuota" value="Credito"> Cr√©dito</label>
                    </div>
                </div>
            </div>

            <div class="form-group" style="margin-bottom: 15px;">
                <label>Email (Opcional):</label>
                <input type="email" id="cuota-email" class="form-control" placeholder="cliente@correo.com">
            </div>

            <div class="form-group">
                <label style="font-size: 11px; font-weight: 800; color: #475569; text-transform: uppercase; display: block; margin-bottom: 5px;">
                    Tama√±o de Impresi√≥n
                </label>
                <div style="display: flex; gap: 10px;">
                    <label class="format-card" style="flex:1; text-align:center; padding:8px; border:1px solid #cbd5e1; border-radius:6px; cursor:pointer;">
                        <input type="radio" name="fmt_cuota" value="3" checked> Ticket
                    </label>
                    <label class="format-card" style="flex:1; text-align:center; padding:8px; border:1px solid #cbd5e1; border-radius:6px; cursor:pointer;">
                        <input type="radio" name="fmt_cuota" value="1"> A4
                    </label>
                    <label class="format-card" style="flex:1; text-align:center; padding:8px; border:1px solid #cbd5e1; border-radius:6px; cursor:pointer;">
                        <input type="radio" name="fmt_cuota" value="2"> A5
                    </label>
                </div>
            </div>

        </div>
        <div class="modal-footer">
            <button class="btn-secondary" onclick="cerrarModalConfirmacion()">Cancelar</button>
            <button class="btn-confirm-pay" onclick="ejecutarPago()">Confirmar y Facturar</button>
        </div>
    </div>
</div>

<div id="modal-historial-total" class="modal-overlay">
    <div class="modal-content" style="max-width: 1000px;">
        <div class="modal-header" style="background: #f0f9ff; border-bottom: 1px solid #bae6fd;">
            <div style="display:flex; align-items:center; gap:10px;">
                <h3 style="color:#0369a1; margin:0;"><i class='bx bx-history'></i> Historial Canjes</h3>
                <span class="badge-count" id="total-registros-hist" style="background:#0ea5e9; color:white; padding:2px 8px; border-radius:10px; font-size:0.8rem;">0</span>
            </div>
            <button class="btn-close" onclick="cerrarModalHistorialTotal()"><i class='bx bx-x'></i></button>
        </div>
        
        <div class="modal-body">
            <div class="filters-bar" style="display:grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap:10px; background:#f8fafc; padding:15px; border-radius:8px; margin-bottom:15px; border:1px solid #e2e8f0;">
                
                <div class="form-group" style="margin:0;">
                    <label style="font-size:0.75rem; font-weight:bold;">Desde:</label>
                    <input type="date" id="filtro-hist-inicio" class="form-control" style="font-size:0.85rem;">
                </div>
                <div class="form-group" style="margin:0;">
                    <label style="font-size:0.75rem; font-weight:bold;">Hasta:</label>
                    <input type="date" id="filtro-hist-fin" class="form-control" style="font-size:0.85rem;">
                </div>

                <div class="form-group" style="margin:0;">
                    <label style="font-size:0.75rem; font-weight:bold;">Canal / Socio:</label>
                    <select id="filtro-hist-canal" class="form-control" style="font-size:0.85rem;">
                        <option value="">Todos</option>
                    </select>
                </div>

                <div class="form-group" style="margin:0;">
                    <label style="font-size:0.75rem; font-weight:bold;">Buscar:</label>
                    <input type="text" id="filtro-hist-search" class="form-control" placeholder="C√≥digo, Usuario..." style="font-size:0.85rem;">
                </div>

                <div style="display:flex; align-items:flex-end; gap:5px;">
                    <button class="btn-primary" onclick="aplicarFiltrosHistorial()" title="Filtrar" style="flex:1;">
                        <i class='bx bx-filter'></i>
                    </button>
                    <button class="btn-success" onclick="exportarHistorialExcel()" title="Exportar Excel" style="background:#16a34a; border-color:#16a34a; flex:1;">
                        <i class='bx bx-spreadsheet'></i> Excel
                    </button>
                </div>
            </div>

            <div class="table-responsive">
                <table class="simple-table" style="font-size: 0.85rem;">
                    <thead>
                        <tr style="background:#f1f5f9;">
                            <th>Fecha</th>
                            <th>Hora</th>
                            <th>C√≥digo</th>
                            <th>Socio / Canal</th>
                            <th>Paquete</th>
                            <th>Usuario</th>
                        </tr>
                    </thead>
                    <tbody id="tabla-historial-total">
                    </tbody>
                </table>
            </div>

            <div class="pagination-controls" style="margin-top: 15px; display: flex; justify-content: center; gap: 10px;">
                <button id="btn-hist-prev" onclick="cambiarPaginaHistorial(-1)" class="btn-sm">Anterior</button>
                <span id="info-hist-page" style="align-self:center; font-weight:bold; font-size:0.9rem;">P√°gina 1</span>
                <button id="btn-hist-next" onclick="cambiarPaginaHistorial(1)" class="btn-sm">Siguiente</button>
            </div>
        </div>
    </div>
</div>